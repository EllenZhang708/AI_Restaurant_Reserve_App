// MapleTable WebSocketå®æ—¶é€šä¿¡æœåŠ¡
class WebSocketService {
    constructor() {
        this.socket = null;
        this.isConnected = false;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        this.reconnectDelay = 1000;
        this.messageQueue = [];
        this.subscribers = new Map();
        this.pingInterval = null;
        this.currentUser = null;
        
        // WebSocketæœåŠ¡å™¨åœ°å€
        this.wsUrl = window.location.hostname === 'localhost' ? 
            'ws://localhost:3001/ws' : 
            'wss://api.mapletable.ca/ws';
    }
    
    // è¿æ¥WebSocket
    connect(userId = null) {
        if (this.socket && this.socket.readyState === WebSocket.OPEN) {
            console.log('ğŸ”Œ WebSocket already connected');
            return;
        }
        
        this.currentUser = userId;
        
        try {
            this.socket = new WebSocket(`${this.wsUrl}?userId=${userId || 'anonymous'}`);
            
            this.socket.onopen = this.onOpen.bind(this);
            this.socket.onmessage = this.onMessage.bind(this);
            this.socket.onclose = this.onClose.bind(this);
            this.socket.onerror = this.onError.bind(this);
            
            console.log('ğŸ”Œ å°è¯•è¿æ¥WebSocket...', this.wsUrl);
            
        } catch (error) {
            console.error('WebSocketè¿æ¥å¤±è´¥:', error);
            this.scheduleReconnect();
        }
    }
    
    // è¿æ¥æˆåŠŸ
    onOpen(event) {
        console.log('âœ… WebSocketè¿æ¥æˆåŠŸ');
        this.isConnected = true;
        this.reconnectAttempts = 0;
        
        // å‘é€è®¤è¯ä¿¡æ¯
        this.authenticate();
        
        // å‘é€ç§¯å‹çš„æ¶ˆæ¯
        this.processMessageQueue();
        
        // å¼€å§‹å¿ƒè·³æ£€æµ‹
        this.startPingInterval();
        
        // é€šçŸ¥è®¢é˜…è€…
        this.notifySubscribers('connection', { status: 'connected' });
    }
    
    // æ¥æ”¶æ¶ˆæ¯
    onMessage(event) {
        try {
            const message = JSON.parse(event.data);
            console.log('ğŸ“¨ æ”¶åˆ°WebSocketæ¶ˆæ¯:', message);
            
            this.handleMessage(message);
            
        } catch (error) {
            console.error('WebSocketæ¶ˆæ¯è§£æå¤±è´¥:', error);
        }
    }
    
    // è¿æ¥å…³é—­\n    onClose(event) {\n        console.log('ğŸ”Œ WebSocketè¿æ¥å…³é—­:', event.code, event.reason);\n        this.isConnected = false;\n        this.clearPingInterval();\n        \n        // éæ­£å¸¸å…³é—­æ—¶å°è¯•é‡è¿\n        if (event.code !== 1000 && event.code !== 1001) {\n            this.scheduleReconnect();\n        }\n        \n        // é€šçŸ¥è®¢é˜…è€…\n        this.notifySubscribers('connection', { status: 'disconnected', code: event.code });\n    }\n    \n    // è¿æ¥é”™è¯¯\n    onError(error) {\n        console.error('âŒ WebSocketé”™è¯¯:', error);\n        this.notifySubscribers('error', { error });\n    }\n    \n    // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯\n    handleMessage(message) {\n        const { type, data, timestamp } = message;\n        \n        switch (type) {\n            case 'booking_confirmed':\n                this.handleBookingConfirmed(data);\n                break;\n                \n            case 'booking_cancelled':\n                this.handleBookingCancelled(data);\n                break;\n                \n            case 'table_ready':\n                this.handleTableReady(data);\n                break;\n                \n            case 'booking_reminder':\n                this.handleBookingReminder(data);\n                break;\n                \n            case 'restaurant_update':\n                this.handleRestaurantUpdate(data);\n                break;\n                \n            case 'promotion':\n                this.handlePromotion(data);\n                break;\n                \n            case 'system_notification':\n                this.handleSystemNotification(data);\n                break;\n                \n            case 'merchant_notification':\n                this.handleMerchantNotification(data);\n                break;\n                \n            case 'pong':\n                // å¿ƒè·³å“åº”\n                break;\n                \n            default:\n                console.warn('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', type);\n        }\n        \n        // é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…\n        this.notifySubscribers(type, data);\n    }\n    \n    // å¤„ç†é¢„è®¢ç¡®è®¤\n    handleBookingConfirmed(data) {\n        const { bookingId, restaurantName, date, time } = data;\n        \n        // æ˜¾ç¤ºé€šçŸ¥\n        this.showNotification({\n            title: 'ğŸ‰ Reservation Confirmed!',\n            titleF: 'ğŸ‰ RÃ©servation ConfirmÃ©e!',\n            body: `Your table at ${restaurantName} on ${date} at ${time} is confirmed.`,\n            bodyF: `Votre table chez ${restaurantName} le ${date} Ã  ${time} est confirmÃ©e.`,\n            type: 'success',\n            actions: [\n                { text: 'View Details', textF: 'Voir DÃ©tails', action: 'view_booking', bookingId },\n                { text: 'Add to Calendar', textF: 'Ajouter au Calendrier', action: 'add_calendar', bookingId }\n            ]\n        });\n        \n        // è§¦è§‰åé¦ˆ\n        this.triggerHaptic('success');\n    }\n    \n    // å¤„ç†é¢„è®¢å–æ¶ˆ\n    handleBookingCancelled(data) {\n        const { bookingId, restaurantName, reason } = data;\n        \n        this.showNotification({\n            title: 'âŒ Reservation Cancelled',\n            titleF: 'âŒ RÃ©servation AnnulÃ©e',\n            body: `Your reservation at ${restaurantName} has been cancelled. ${reason || ''}`,\n            bodyF: `Votre rÃ©servation chez ${restaurantName} a Ã©tÃ© annulÃ©e. ${reason || ''}`,\n            type: 'warning',\n            actions: [\n                { text: 'Find Alternative', textF: 'Trouver Alternative', action: 'find_alternative' }\n            ]\n        });\n    }\n    \n    // å¤„ç†æ¡Œä½å°±ç»ª\n    handleTableReady(data) {\n        const { bookingId, restaurantName, tableNumber } = data;\n        \n        this.showNotification({\n            title: 'ğŸ½ï¸ Your Table is Ready!',\n            titleF: 'ğŸ½ï¸ Votre Table est PrÃªte!',\n            body: `Table ${tableNumber} at ${restaurantName} is ready for you.`,\n            bodyF: `La table ${tableNumber} chez ${restaurantName} vous attend.`,\n            type: 'info',\n            urgent: true,\n            actions: [\n                { text: 'I\\'m on my way', textF: 'J\\'arrive', action: 'confirm_arrival', bookingId },\n                { text: 'Need more time', textF: 'Besoin de temps', action: 'delay_arrival', bookingId }\n            ]\n        });\n        \n        this.triggerHaptic('notification');\n    }\n    \n    // å¤„ç†é¢„è®¢æé†’\n    handleBookingReminder(data) {\n        const { bookingId, restaurantName, timeUntil, address } = data;\n        \n        this.showNotification({\n            title: 'â° Upcoming Reservation',\n            titleF: 'â° RÃ©servation Prochaine',\n            body: `Your reservation at ${restaurantName} is in ${timeUntil}. Don't forget!`,\n            bodyF: `Votre rÃ©servation chez ${restaurantName} est dans ${timeUntil}. N'oubliez pas!`,\n            type: 'info',\n            actions: [\n                { text: 'Get Directions', textF: 'ItinÃ©raire', action: 'get_directions', address },\n                { text: 'Call Restaurant', textF: 'Appeler', action: 'call_restaurant', bookingId }\n            ]\n        });\n    }\n    \n    // å¤„ç†é¤å…æ›´æ–°\n    handleRestaurantUpdate(data) {\n        const { restaurantId, updateType, message } = data;\n        \n        if (updateType === 'menu_update') {\n            this.showNotification({\n                title: 'ğŸ½ï¸ Menu Updated',\n                titleF: 'ğŸ½ï¸ Menu Mis Ã  Jour',\n                body: message,\n                type: 'info'\n            });\n        } else if (updateType === 'special_offer') {\n            this.showNotification({\n                title: 'ğŸ Special Offer',\n                titleF: 'ğŸ Offre SpÃ©ciale',\n                body: message,\n                type: 'promotion'\n            });\n        }\n    }\n    \n    // å¤„ç†æ¨å¹¿æ´»åŠ¨\n    handlePromotion(data) {\n        const { title, message, restaurantName, discount, validUntil } = data;\n        \n        this.showNotification({\n            title: `ğŸ‰ ${title}`,\n            body: `${message} at ${restaurantName}. Valid until ${validUntil}`,\n            bodyF: `${message} chez ${restaurantName}. Valable jusqu'au ${validUntil}`,\n            type: 'promotion',\n            actions: [\n                { text: 'Book Now', textF: 'RÃ©server', action: 'book_promotion', data },\n                { text: 'Save Offer', textF: 'Sauvegarder', action: 'save_offer', data }\n            ]\n        });\n    }\n    \n    // å¤„ç†ç³»ç»Ÿé€šçŸ¥\n    handleSystemNotification(data) {\n        const { level, message, messageF } = data;\n        \n        this.showNotification({\n            title: level === 'urgent' ? 'ğŸš¨ Important Notice' : 'â„¹ï¸ System Notice',\n            titleF: level === 'urgent' ? 'ğŸš¨ Avis Important' : 'â„¹ï¸ Avis SystÃ¨me',\n            body: message,\n            bodyF: messageF,\n            type: level === 'urgent' ? 'error' : 'info'\n        });\n    }\n    \n    // å¤„ç†å•†å®¶é€šçŸ¥\n    handleMerchantNotification(data) {\n        // åªæœ‰å•†å®¶ç”¨æˆ·æ‰å¤„ç†è¿™ç±»é€šçŸ¥\n        if (!this.isMerchantUser()) return;\n        \n        const { notificationType, booking, message } = data;\n        \n        switch (notificationType) {\n            case 'new_booking':\n                this.showNotification({\n                    title: 'ğŸ“… New Booking',\n                    titleF: 'ğŸ“… Nouvelle RÃ©servation',\n                    body: `New reservation for ${booking.partySize} people at ${booking.time}`,\n                    bodyF: `Nouvelle rÃ©servation pour ${booking.partySize} personnes Ã  ${booking.time}`,\n                    type: 'info',\n                    actions: [\n                        { text: 'View Details', textF: 'Voir DÃ©tails', action: 'view_merchant_booking', bookingId: booking.id }\n                    ]\n                });\n                break;\n                \n            case 'booking_modification':\n                this.showNotification({\n                    title: 'âœï¸ Booking Modified',\n                    titleF: 'âœï¸ RÃ©servation ModifiÃ©e',\n                    body: message,\n                    type: 'info'\n                });\n                break;\n        }\n    }\n    \n    // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨\n    sendMessage(message) {\n        if (this.isConnected && this.socket) {\n            try {\n                this.socket.send(JSON.stringify({\n                    ...message,\n                    timestamp: Date.now(),\n                    userId: this.currentUser\n                }));\n                return true;\n            } catch (error) {\n                console.error('å‘é€WebSocketæ¶ˆæ¯å¤±è´¥:', error);\n                this.messageQueue.push(message);\n                return false;\n            }\n        } else {\n            console.warn('WebSocketæœªè¿æ¥ï¼Œæ¶ˆæ¯å·²åŠ å…¥é˜Ÿåˆ—');\n            this.messageQueue.push(message);\n            return false;\n        }\n    }\n    \n    // è®¤è¯ç”¨æˆ·\n    authenticate() {\n        const token = localStorage.getItem('mapletable_auth_token') || \n                      localStorage.getItem('mapletable_merchant_token');\n        \n        if (token) {\n            this.sendMessage({\n                type: 'authenticate',\n                data: { token, userId: this.currentUser }\n            });\n        }\n    }\n    \n    // å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—\n    processMessageQueue() {\n        while (this.messageQueue.length > 0) {\n            const message = this.messageQueue.shift();\n            this.sendMessage(message);\n        }\n    }\n    \n    // å¼€å§‹å¿ƒè·³æ£€æµ‹\n    startPingInterval() {\n        this.pingInterval = setInterval(() => {\n            if (this.isConnected) {\n                this.sendMessage({ type: 'ping' });\n            }\n        }, 30000); // æ¯30ç§’å‘é€ä¸€æ¬¡å¿ƒè·³\n    }\n    \n    // åœæ­¢å¿ƒè·³æ£€æµ‹\n    clearPingInterval() {\n        if (this.pingInterval) {\n            clearInterval(this.pingInterval);\n            this.pingInterval = null;\n        }\n    }\n    \n    // è®¡åˆ’é‡è¿\n    scheduleReconnect() {\n        if (this.reconnectAttempts < this.maxReconnectAttempts) {\n            this.reconnectAttempts++;\n            const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1);\n            \n            console.log(`ğŸ”„ ${delay}msåå°è¯•é‡è¿ (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`);\n            \n            setTimeout(() => {\n                this.connect(this.currentUser);\n            }, delay);\n        } else {\n            console.error('âŒ WebSocketé‡è¿è¾¾åˆ°æœ€å¤§æ¬¡æ•°é™åˆ¶');\n        }\n    }\n    \n    // æ–­å¼€è¿æ¥\n    disconnect() {\n        if (this.socket) {\n            this.socket.close(1000, 'User disconnection');\n            this.socket = null;\n        }\n        this.clearPingInterval();\n        this.isConnected = false;\n        console.log('ğŸ”Œ WebSocketå·²æ–­å¼€');\n    }\n    \n    // è®¢é˜…æ¶ˆæ¯ç±»å‹\n    subscribe(messageType, callback) {\n        if (!this.subscribers.has(messageType)) {\n            this.subscribers.set(messageType, new Set());\n        }\n        this.subscribers.get(messageType).add(callback);\n        \n        // è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°\n        return () => {\n            this.unsubscribe(messageType, callback);\n        };\n    }\n    \n    // å–æ¶ˆè®¢é˜…\n    unsubscribe(messageType, callback) {\n        const callbacks = this.subscribers.get(messageType);\n        if (callbacks) {\n            callbacks.delete(callback);\n        }\n    }\n    \n    // é€šçŸ¥è®¢é˜…è€…\n    notifySubscribers(messageType, data) {\n        const callbacks = this.subscribers.get(messageType);\n        if (callbacks) {\n            callbacks.forEach(callback => {\n                try {\n                    callback(data);\n                } catch (error) {\n                    console.error('è®¢é˜…è€…å›è°ƒæ‰§è¡Œå¤±è´¥:', error);\n                }\n            });\n        }\n    }\n    \n    // æ˜¾ç¤ºé€šçŸ¥\n    showNotification({ title, titleF, body, bodyF, type = 'info', urgent = false, actions = [] }) {\n        const currentLang = localStorage.getItem('mapleTableLanguage') || 'en';\n        const finalTitle = currentLang === 'fr' && titleF ? titleF : title;\n        const finalBody = currentLang === 'fr' && bodyF ? bodyF : body;\n        \n        // å°è¯•æ˜¾ç¤ºåŸç”Ÿé€šçŸ¥\n        if ('Notification' in window && Notification.permission === 'granted') {\n            const notification = new Notification(finalTitle, {\n                body: finalBody,\n                icon: '/android-chrome-192x192.png',\n                badge: '/android-chrome-192x192.png',\n                tag: type,\n                requireInteraction: urgent\n            });\n            \n            // ç‚¹å‡»é€šçŸ¥çš„å¤„ç†\n            notification.onclick = () => {\n                window.focus();\n                if (actions.length > 0) {\n                    this.handleNotificationAction(actions[0]);\n                }\n                notification.close();\n            };\n        }\n        \n        // åŒæ—¶æ˜¾ç¤ºåº”ç”¨å†…é€šçŸ¥\n        this.showInAppNotification({\n            title: finalTitle,\n            body: finalBody,\n            type,\n            actions,\n            urgent\n        });\n    }\n    \n    // æ˜¾ç¤ºåº”ç”¨å†…é€šçŸ¥\n    showInAppNotification({ title, body, type, actions, urgent }) {\n        // åˆ›å»ºé€šçŸ¥å…ƒç´ \n        const notification = document.createElement('div');\n        notification.className = `notification in-app-notification ${type} ${urgent ? 'urgent' : ''}`;\n        \n        notification.innerHTML = `\n            <div class=\"notification-content\">\n                <div class=\"notification-header\">\n                    <h4>${title}</h4>\n                    <button class=\"close-notification\" onclick=\"this.parentElement.parentElement.parentElement.remove()\">\n                        <i class=\"fas fa-times\"></i>\n                    </button>\n                </div>\n                <p>${body}</p>\n                ${actions.length > 0 ? `\n                    <div class=\"notification-actions\">\n                        ${actions.map((action, index) => `\n                            <button class=\"notification-action\" onclick=\"wsService.handleNotificationAction(${JSON.stringify(action).replace(/\"/g, '&quot;')})\">\n                                ${action.text}\n                            </button>\n                        `).join('')}\n                    </div>\n                ` : ''}\n            </div>\n        `;\n        \n        // æ·»åŠ åˆ°é¡µé¢\n        document.body.appendChild(notification);\n        \n        // è‡ªåŠ¨ç§»é™¤ï¼ˆé™¤éæ˜¯ç´§æ€¥é€šçŸ¥ï¼‰\n        if (!urgent) {\n            setTimeout(() => {\n                if (notification.parentNode) {\n                    notification.remove();\n                }\n            }, 8000);\n        }\n    }\n    \n    // å¤„ç†é€šçŸ¥åŠ¨ä½œ\n    handleNotificationAction(action) {\n        switch (action.action) {\n            case 'view_booking':\n                window.location.href = `reservations.html?booking=${action.bookingId}`;\n                break;\n            case 'add_calendar':\n                this.addBookingToCalendar(action.bookingId);\n                break;\n            case 'find_alternative':\n                window.location.href = 'index.html';\n                break;\n            case 'get_directions':\n                this.openDirections(action.address);\n                break;\n            case 'call_restaurant':\n                this.callRestaurant(action.bookingId);\n                break;\n            // ... æ›´å¤šåŠ¨ä½œå¤„ç†\n        }\n    }\n    \n    // è§¦è§‰åé¦ˆ\n    triggerHaptic(type) {\n        if (window.Capacitor && window.Capacitor.Plugins.Haptics) {\n            try {\n                const { Haptics } = window.Capacitor.Plugins;\n                switch (type) {\n                    case 'success':\n                        Haptics.notification({ type: 'SUCCESS' });\n                        break;\n                    case 'warning':\n                        Haptics.notification({ type: 'WARNING' });\n                        break;\n                    case 'error':\n                        Haptics.notification({ type: 'ERROR' });\n                        break;\n                    default:\n                        Haptics.impact({ style: 'LIGHT' });\n                }\n            } catch (error) {\n                console.warn('è§¦è§‰åé¦ˆå¤±è´¥:', error);\n            }\n        }\n    }\n    \n    // æ£€æŸ¥æ˜¯å¦ä¸ºå•†å®¶ç”¨æˆ·\n    isMerchantUser() {\n        return localStorage.getItem('mapletable_merchant_token') !== null;\n    }\n    \n    // å·¥å…·æ–¹æ³•\n    openDirections(address) {\n        const url = `https://maps.google.com/maps?daddr=${encodeURIComponent(address)}`;\n        window.open(url, '_blank');\n    }\n    \n    callRestaurant(bookingId) {\n        // ä»æœ¬åœ°æ•°æ®æˆ–APIè·å–é¤å…ç”µè¯\n        const bookings = JSON.parse(localStorage.getItem('mapleTableBookings') || '[]');\n        const booking = bookings.find(b => b.id === bookingId);\n        if (booking && booking.restaurantPhone) {\n            window.location.href = `tel:${booking.restaurantPhone}`;\n        }\n    }\n    \n    addBookingToCalendar(bookingId) {\n        // Google Calendaré›†æˆ\n        const bookings = JSON.parse(localStorage.getItem('mapleTableBookings') || '[]');\n        const booking = bookings.find(b => b.id === bookingId);\n        if (booking) {\n            const startDate = new Date(`${booking.date}T${booking.time}:00`);\n            const endDate = new Date(startDate.getTime() + 2 * 60 * 60 * 1000);\n            \n            const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent('Dinner at ' + booking.restaurantName)}&dates=${startDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z/${endDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z`;\n            \n            window.open(googleUrl, '_blank');\n        }\n    }\n}\n\n// åˆ›å»ºå…¨å±€WebSocketæœåŠ¡å®ä¾‹\nconst wsService = new WebSocketService();\n\n// å¯¼å‡ºæœåŠ¡\nif (typeof module !== 'undefined' && module.exports) {\n    module.exports = WebSocketService;\n} else if (typeof window !== 'undefined') {\n    window.WebSocketService = WebSocketService;\n    window.wsService = wsService;\n}\n\nconsole.log('ğŸ”„ MapleTable WebSocket Service initialized');